#!/bin/bash

# ðŸ•·ï¸ SILK - Smart Integrated Literary Kit v1.0
# Structured Intelligence for Literary Kreation
# Modern CLI workflow for authors with LLM integration
# Compatible: Git Bash (Windows), Linux, macOS

set -euo pipefail

# === CONFIGURATION GLOBALE ===
SILK_VERSION="1.0.0"
SILK_HOME="${SILK_HOME:-$HOME/.silk}"
SILK_CONFIG="$SILK_HOME/config"
VAULT_MARKER="## manuscrit"

# === COULEURS ===
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    PURPLE='\033[0;35m'
    CYAN='\033[0;36m'
    NC='\033[0m' # No Color
else
    RED='' GREEN='' YELLOW='' BLUE='' PURPLE='' CYAN='' NC=''
fi

# === FONCTIONS UTILITAIRES ===
log_info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
log_success() { echo -e "${GREEN}âœ… $1${NC}"; }
log_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
log_error() { echo -e "${RED}âŒ $1${NC}"; }
log_header() { echo -e "${PURPLE}ðŸ•·ï¸  $1${NC}"; }

detect_os() {
    case "$OSTYPE" in
        msys*|cygwin*|mingw*) echo "windows" ;;
        darwin*) echo "macos" ;;
        linux*) echo "linux" ;;
        *) echo "unknown" ;;
    esac
}

is_silk_project() {
    [[ -d "01-Manuscrit" && -d "02-Personnages" && -d "04-Concepts" ]]
}

find_silk_root() {
    local current_dir="$PWD"
    while [[ "$current_dir" != "/" ]]; do
        if [[ -d "$current_dir/01-Manuscrit" ]]; then
            echo "$current_dir"
            return 0
        fi
        current_dir="$(dirname "$current_dir")"
    done
    return 1
}

ensure_silk_context() {
    if ! is_silk_project; then
        local silk_root
        if silk_root=$(find_silk_root); then
            log_info "Projet SILK trouvÃ© dans: $silk_root"
            cd "$silk_root"
        else
            log_error "Pas dans un projet SILK. Utilisez 'silk init' pour crÃ©er un projet."
            exit 1
        fi
    fi
}

# === GESTION CONFIGURATION ===
load_config() {
    mkdir -p "$SILK_HOME"
    if [[ -f "$SILK_CONFIG" ]]; then
        source "$SILK_CONFIG"
    fi
    
    # Valeurs par dÃ©faut
    SILK_DEFAULT_GENRE="${SILK_DEFAULT_GENRE:-polar-psychologique}"
    SILK_DEFAULT_LANGUAGE="${SILK_DEFAULT_LANGUAGE:-fr}"
    SILK_DEFAULT_TARGET_WORDS="${SILK_DEFAULT_TARGET_WORDS:-80000}"
    SILK_DEFAULT_CHAPTERS="${SILK_DEFAULT_CHAPTERS:-30}"
    SILK_DEFAULT_FORMAT="${SILK_DEFAULT_FORMAT:-digital}"
    SILK_AUTHOR_NAME="${SILK_AUTHOR_NAME:-}"
    SILK_AUTHOR_PSEUDO="${SILK_AUTHOR_PSEUDO:-}"
}

save_config() {
    cat > "$SILK_CONFIG" << EOF
# SILK Configuration - Smart Integrated Literary Kit
SILK_DEFAULT_GENRE="${SILK_DEFAULT_GENRE:-polar-psychologique}"
SILK_DEFAULT_LANGUAGE="${SILK_DEFAULT_LANGUAGE:-fr}"
SILK_DEFAULT_TARGET_WORDS="${SILK_DEFAULT_TARGET_WORDS:-80000}"
SILK_DEFAULT_CHAPTERS="${SILK_DEFAULT_CHAPTERS:-30}"
SILK_DEFAULT_FORMAT="${SILK_DEFAULT_FORMAT:-digital}"
SILK_AUTHOR_NAME="${SILK_AUTHOR_NAME:-}"
SILK_AUTHOR_PSEUDO="${SILK_AUTHOR_PSEUDO:-}"
EOF
}

# === COMMANDE INIT ===
cmd_init() {
    local project_name=""
    local genre="$SILK_DEFAULT_GENRE"
    local language="$SILK_DEFAULT_LANGUAGE"
    local target_words="$SILK_DEFAULT_TARGET_WORDS"
    local target_chapters="$SILK_DEFAULT_CHAPTERS"
    local author_name="$SILK_AUTHOR_NAME"
    local author_pseudo="$SILK_AUTHOR_PSEUDO"
    local interactive=true
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                cat << 'HELP'
ðŸ•·ï¸ SILK INIT - CrÃ©er un nouveau projet littÃ©raire

USAGE:
  silk init [PROJECT_NAME] [OPTIONS]

OPTIONS:
  -g, --genre GENRE          Genre du projet 
  -l, --language LANG        Langue (fr, en, es, de)
  -w, --words NUMBER         Objectif mots (dÃ©faut: 80000)
  -c, --chapters NUMBER      Nombre de chapitres (dÃ©faut: 30)
  -a, --author NAME          Nom auteur
  -p, --pseudo PSEUDO        Pseudonyme auteur
  -y, --yes                  Mode non-interactif
  -h, --help                 Afficher cette aide

EXEMPLES:
  silk init "L'AraignÃ©e"                         # Mode interactif
  silk init "Dark Mystery" --genre fantasy       # Projet fantasy
  silk init "Love Story" -w 60000 -c 25 -y      # Romance courte

GENRES DISPONIBLES:
  polar-psychologique    Polar sophistiquÃ© avec Ã©lÃ©ments psychologiques
  fantasy               Fantasy/fantastique avec worldbuilding
  romance               Romance/sentiment avec dÃ©veloppement relationnel
  literary              LittÃ©rature gÃ©nÃ©rale/contemporaine
  thriller              Thriller/suspense action
  
SILK = Smart Integrated Literary Kit
Tisse ensemble tous les Ã©lÃ©ments de votre roman comme une araignÃ©e tisse sa toile.
HELP
                return 0
                ;;
            -g|--genre)
                genre="$2"
                shift 2
                ;;
            -l|--language)
                language="$2"
                shift 2
                ;;
            -w|--words)
                target_words="$2"
                shift 2
                ;;
            -c|--chapters)
                target_chapters="$2"
                shift 2
                ;;
            -a|--author)
                author_name="$2"
                shift 2
                ;;
            -p|--pseudo)
                author_pseudo="$2"
                shift 2
                ;;
            -y|--yes)
                interactive=false
                shift
                ;;
            -*)
                log_error "Option inconnue: $1"
                return 1
                ;;
            *)
                if [[ -z "$project_name" ]]; then
                    project_name="$1"
                fi
                shift
                ;;
        esac
    done
    
    # Mode interactif
    if [[ "$interactive" == "true" ]]; then
        log_header "SILK INIT - Smart Integrated Literary Kit"
        echo -e "${CYAN}Tissons ensemble votre nouveau projet littÃ©raire...${NC}"
        echo
        
        if [[ -z "$project_name" ]]; then
            read -p "ðŸ“– Nom du projet: " project_name
        fi
        
        echo -e "\nðŸŽ­ Genres disponibles:"
        echo "   polar-psychologique (expertise auteur L'AraignÃ©e)"
        echo "   fantasy (worldbuilding structurÃ©)"
        echo "   romance (arc relationnel dÃ©veloppÃ©)"
        echo "   literary (littÃ©rature gÃ©nÃ©rale)"
        echo "   thriller (suspense action)"
        read -p "ðŸŽ­ Genre [$genre]: " input_genre
        genre="${input_genre:-$genre}"
        
        read -p "ðŸŒ Langue [$language]: " input_language
        language="${input_language:-$language}"
        
        read -p "ðŸ“Š Objectif mots [$target_words]: " input_words
        target_words="${input_words:-$target_words}"
        
        read -p "ðŸ“š Nombre chapitres [$target_chapters]: " input_chapters
        target_chapters="${input_chapters:-$target_chapters}"
        
        read -p "âœï¸  Nom auteur [$author_name]: " input_author
        author_name="${input_author:-$author_name}"
        
        read -p "ðŸŽ­ Pseudonyme [$author_pseudo]: " input_pseudo
        author_pseudo="${input_pseudo:-$author_pseudo}"
    fi
    
    # Validation
    if [[ -z "$project_name" ]]; then
        log_error "Nom de projet requis"
        return 1
    fi
    
    # CrÃ©ation structure
    local project_dir="${project_name// /-}"
    project_dir="${project_dir,,}"  # lowercase
    
    if [[ -d "$project_dir" ]]; then
        log_error "Le rÃ©pertoire '$project_dir' existe dÃ©jÃ "
        return 1
    fi
    
    log_info "Tissage du projet '$project_name' dans '$project_dir'"
    
    # CrÃ©er structure selon le genre
    create_project_structure "$project_dir" "$project_name" "$genre" "$language" "$target_words" "$target_chapters" "$author_name" "$author_pseudo"
    
    log_success "Projet '$project_name' tissÃ© avec succÃ¨s !"
    echo
    log_info "Prochaines Ã©tapes:"
    echo "  cd $project_dir"
    echo "  silk context --help     # Contexte LLM optimisÃ©"
    echo "  silk wordcount          # Suivi progression"
    echo "  silk publish --help     # Publication PDF"
}

create_project_structure() {
    local project_dir="$1"
    local project_name="$2"
    local genre="$3"
    local language="$4"
    local target_words="$5"
    local target_chapters="$6"
    local author_name="$7"
    local author_pseudo="$8"
    
    mkdir -p "$project_dir"
    cd "$project_dir"
    
    # Structure SILK standardisÃ©e
    mkdir -p {00-instructions-llm,01-Manuscrit,02-Personnages/{Principaux,Secondaires},03-Lieux,04-Concepts,07-timeline,10-Lore,20-Pitch-Editeurs,21-Planning,50-Sessions-Claude,60-idees-tome-2,99-Templates}
    mkdir -p {formats,outputs/{context,publish,temp},filters,.github/workflows}
    
    # Git init
    git init
    
    # README avec branding SILK
    cat > README.md << EOF
# ðŸ•·ï¸ $project_name
*Projet SILK - Smart Integrated Literary Kit*

**Genre**: $genre  
**Langue**: $language  
**Objectif**: $target_words mots ($target_chapters chapitres)  
**Auteur**: $author_name${author_pseudo:+ (pseudo: $author_pseudo)}

GÃ©nÃ©rÃ© avec SILK v$SILK_VERSION - *Structured Intelligence for Literary Kreation*

## ðŸ•¸ï¸ Structure SILK

SILK tisse ensemble tous les Ã©lÃ©ments de votre roman :

- \`01-Manuscrit/\` - Chapitres du manuscrit (avec sÃ©parateur \`## manuscrit\`)
- \`02-Personnages/\` - Fiches personnages hiÃ©rarchisÃ©es  
- \`04-Concepts/\` - MÃ©caniques narratives et intrigue
- \`outputs/\` - Fichiers gÃ©nÃ©rÃ©s (contexte LLM, PDF)

## ðŸš€ Workflow SILK

\`\`\`bash
silk context              # GÃ©nÃ©rer contexte optimisÃ© pour LLM
silk wordcount           # Statistiques progression intelligentes
silk publish             # GÃ©nÃ©rer PDF professionnel multi-format
\`\`\`

## ðŸ¤– IntÃ©gration LLM

### SÃ©parateur standardisÃ©
Chaque chapitre utilise la convention SILK :
\`\`\`markdown
# Ch.X : Titre

## Objectifs
[MÃ©tadonnÃ©es pour planification]

## manuscrit
[Contenu pur pour analyse LLM]
\`\`\`

### Contexte intelligent
- Range flexible : \`-ch 1-10\`, \`-ch 15,20,25\`
- Mode normal : Essentiel (personnages + concepts)
- Mode complet : \`--full\` (+ lieux + statistiques)

## ðŸ“– Documentation

Ce projet suit les conventions SILK pour l'Ã©criture moderne avec IA.
Chaque gÃ©nÃ©ration inclut templates optimisÃ©s par genre et marchÃ©.

*SILK weaves your story together - like a spider weaves its web*
EOF
    
    # Templates selon genre
    create_genre_templates "$genre" "$language" "$project_name" "$author_name" "$author_pseudo"
    
    # Configuration publication
    create_publishing_templates "$project_name" "$author_name"
    
    # Gitignore
    cat > .gitignore << 'EOF'
.DS_Store
Thumbs.db
*.tmp
*~
outputs/temp/
.silk-cache/
EOF
    
    # Premier commit avec branding SILK
    git add .
    git commit -m "ðŸ•·ï¸ Initial SILK project: $project_name

ðŸ•¸ï¸ Smart Integrated Literary Kit v$SILK_VERSION
ðŸ“š Projet: $project_name
ðŸŽ­ Genre: $genre  
ðŸŽ¯ Objectif: $target_words mots ($target_chapters chapitres)
âœï¸ Auteur: $author_name

Structure tissÃ©e avec templates $genre optimisÃ©s.
Ready for: silk context, wordcount, publish"
    
    log_success "Structure SILK crÃ©Ã©e et initialisÃ©e avec Git"
}

create_genre_templates() {
    local genre="$1"
    local language="$2" 
    local project_name="$3"
    local author_name="$4"
    local author_pseudo="$5"
    
    case "$genre" in
        "polar-psychologique")
            create_polar_templates "$project_name" "$author_name" "$author_pseudo"
            ;;
        "fantasy")
            create_fantasy_templates "$project_name" "$author_name" "$author_pseudo"
            ;;
        "romance")
            create_romance_templates "$project_name" "$author_name" "$author_pseudo"
            ;;
        *)
            create_literary_templates "$project_name" "$author_name" "$author_pseudo"
            ;;
    esac
    
    # Template chapitre SILK universel
    cat > "99-Templates/Template-Chapitre.md" << 'EOF'
# Ch.X : [TITRE]

## Objectifs SILK
- **Intrigue** : Avancement enquÃªte/conflit principal
- **DÃ©veloppement** : Ã‰volution personnages
- **RÃ©vÃ©lations** : Informations dÃ©voilÃ©es au lecteur
- **Tension** : Niveau suspense/Ã©motion

## Personnages actifs
- [[Protagoniste]] : Actions et motivations
- [[DeutÃ©ragoniste]] : RÃ´le dans ce chapitre

## Liens narratifs
â† Ch.X : ContinuitÃ© depuis chapitre prÃ©cÃ©dent
â†’ Ch.X : PrÃ©paration chapitre suivant

## manuscrit

*[SILK: Tout le contenu aprÃ¨s cette ligne sera analysÃ© par LLM]*

[DÃ©but du chapitre...]
EOF

    # Template personnage SILK
    cat > "99-Templates/Template-Personnage.md" << 'EOF'
# [Nom Personnage]

## IdentitÃ©
- **Ã‚ge** : 
- **Fonction** : 
- **Statut social** : 

## Psychologie SILK
### Motivations profondes
- **DÃ©sir conscient** : Ce que le personnage pense vouloir
- **Besoin inconscient** : Ce dont il a vraiment besoin
- **Peur principale** : Ce qui le paralyse

### Failles et contradictions  
- **DÃ©faut majeur** : Trait qui cause des problÃ¨mes
- **Force cachÃ©e** : Potentiel non exploitÃ©
- **Ã‰volution prÃ©vue** : Arc de transformation

## Relations
- [[Personnage]] : Nature relation et Ã©volution

## Arc narratif
- **Introduction** : PremiÃ¨re apparition et impression
- **DÃ©veloppement** : RÃ©vÃ©lation progressive de la complexitÃ©  
- **Climax** : Moment de vÃ©ritÃ©/choix crucial
- **RÃ©solution** : Ã‰tat final et apprentissage

## Notes dÃ©veloppement SILK
> Intelligence narrative : Comment ce personnage sert l'intrigue
> RÃ©sonance Ã©motionnelle : Impact sur le lecteur cible
EOF
}

create_polar_templates() {
    local project_name="$1"
    local author_name="$2" 
    local author_pseudo="$3"
    
    # Instructions LLM spÃ©cialisÃ©es polar + SILK
    cat > "00-instructions-llm/instructions.md" << EOF
# Instructions LLM - $project_name
*Projet SILK - Smart Integrated Literary Kit*

## ðŸŽ¯ CONTEXTE PROJET
**Genre** : Polar sophistiquÃ©/psychologique  
**Public cible** : Lectrices CSP/CSP+ 35-55 ans (expertise L'AraignÃ©e)
**Auteur** : $author_name${author_pseudo:+ (pseudo: $author_pseudo)}
**Architecture** : SILK - Structure intelligence intÃ©grÃ©e

## ðŸ•·ï¸ PHILOSOPHIE SILK
SILK tisse ensemble tous les Ã©lÃ©ments narratifs comme une araignÃ©e tisse sa toile :
- **Smart** : Templates adaptÃ©s genre et marchÃ©
- **Integrated** : Workflow unifiÃ© conceptionâ†’publication
- **Literary** : Focus sur fiction sophistiquÃ©e
- **Kit** : BoÃ®te Ã  outils complÃ¨te auteur

## ðŸ§  MÃ‰CANIQUES POLAR SILK
### Structure enquÃªte intelligente
- **MystÃ¨re central** : RÃ©vÃ©lations progressives calculÃ©es
- **EnquÃªte mÃ©thodique** : Logique dÃ©ductive crÃ©dible
- **Psychologie approfondie** : Motivations complexes et nuancÃ©es
- **Fausses pistes** : Misdirection Ã©lÃ©gante sans frustration

### Style et ton (public femmes CSP+ 35-55)
- **Sophistication accessible** : Intelligent sans prÃ©tention
- **DÃ©veloppement Ã©motionnel** : Profondeur psychologique
- **Dialogue authentique** : Voix diffÃ©renciÃ©es par personnage
- **Rythme maÃ®trisÃ©** : Alternance tension/respiration

## ðŸ“‹ INSTRUCTIONS SPÃ‰CIFIQUES SILK
### Analyse Personnages
- Psychologie crÃ©dible et Ã©volutive
- Motivations claires avec contradictions humaines
- Relations authentiques et dynamiques
- Arc de transformation satisfaisant

### Structure Narrative  
- Ã‰quilibre investigation/dÃ©veloppement personnel
- Rythme soutenu avec respirations Ã©motionnelles
- RÃ©vÃ©lations prÃ©parÃ©es et logiquement satisfaisantes
- RÃ©solution surprenante mais inÃ©vitable rÃ©trospectivement

### Contexte marchÃ© franÃ§ais
- RÃ©fÃ©rences culturelles parisiennes/franÃ§aises
- Codes sociaux CSP+ intÃ©grÃ©s naturellement
- Ã‰viter clichÃ©s amÃ©ricains du genre
- Ancrage gÃ©ographique prÃ©cis et vÃ©cu
EOF

    # Concepts spÃ©cifiques polar SILK
    cat > "04-Concepts/EnquÃªte-Structure.md" << 'EOF'
# Structure d'EnquÃªte SILK

## MÃ©thodologie narrative
- **ScÃ¨ne de crime** : Ã‰tablissement mystÃ¨re avec Ã©lÃ©ments intriguants
- **Collecte indices** : Progression logique avec surprises
- **Interrogatoires** : RÃ©vÃ©lation personnalitÃ©s et relations
- **Fausses pistes** : Maintien suspense sans manipulation lecteur
- **RÃ©vÃ©lation finale** : RÃ©solution logique et Ã©motionnellement satisfaisante

## Rythme SILK (30 chapitres)
- **Setup** : Accroche et Ã©tablissement univers (Ch1-3)
- **Investigation** : DÃ©veloppement enquÃªte et personnages (Ch4-20)
- **Complications** : Escalade tension et rÃ©vÃ©lations (Ch21-26)
- **Climax** : Confrontation et rÃ©vÃ©lation (Ch27-28)
- **RÃ©solution** : DÃ©nouement et ouverture (Ch29-30)

## SpÃ©cificitÃ©s public cible
- **Lectrices CSP+ 35-55** : Sophistication psychologique
- **Attentes genre** : Justice, mais nuancÃ©e
- **Engagement Ã©motionnel** : Identification protagonistes
- **RÃ©alisme social** : CrÃ©dibilitÃ© environnement professionnel/social
EOF

    # Exemple chapitre polar
    cat > "01-Manuscrit/Ch01-Premier-Contact.md" << 'EOF'
# Ch.01 : Premier Contact

## Objectifs SILK
- **Intrigue** : Ã‰tablir le mystÃ¨re central et accrocher le lecteur
- **DÃ©veloppement** : PrÃ©senter protagoniste avec dÃ©faut intriguant
- **RÃ©vÃ©lations** : Indices subtils pour relecture
- **Tension** : Malaise immÃ©diat, questions sans rÃ©ponses

## Personnages actifs
- [[Protagoniste]] : Introduction avec vulnÃ©rabilitÃ© et compÃ©tence
- [[Victime]] : Ã‰tablir sympathie et mystÃ¨re
- [[TÃ©moins]] : Premiers Ã©lÃ©ments contradictoires

## Liens narratifs
â† DÃ©but : Immersion directe in medias res
â†’ Ch.02 : Approfondissement enquÃªte et protagoniste

## manuscrit

Le tÃ©lÃ©phone vibrait depuis trois minutes sur la table de nuit. Claire Moreau observait l'Ã©cran dans la pÃ©nombre de sa chambre, 6h42 du matin, "Commissariat - Urgent" qui clignotait avec insistance.

Elle savait dÃ©jÃ  que sa journÃ©e de congÃ© venait de s'Ã©vaporer.

â€” Moreau.

â€” Claire ? C'est Dubois. DÃ©solÃ© de te rÃ©veiller, mais on a un problÃ¨me.

Sa voix portait cette tension particuliÃ¨re qu'elle ne lui connaissait que dans les affaires compliquÃ©es. Le genre d'affaires qui font la une des journaux et donnent des cauchemars aux commissaires.

â€” Quel genre de problÃ¨me ?

â€” Le genre qui va nous occuper pendant des semaines. Une femme, la quarantaine, retrouvÃ©e dans son appartement du 16Ã¨me. ScÃ¨ne... particuliÃ¨re.

Claire s'assit dans son lit, dÃ©jÃ  en train d'enfiler mentalement sa tenue de travail.

â€” ParticuliÃ¨re comment ?

â€” Tu verras. 47 avenue Foch, au sixiÃ¨me. L'identitÃ© judiciaire est dÃ©jÃ  sur place.

*[Continuez le chapitre en dÃ©veloppant l'arrivÃ©e sur la scÃ¨ne de crime, les premiers indices troublants, et l'Ã©tablissement du mystÃ¨re central...]*
EOF
}

create_fantasy_templates() {
    local project_name="$1"
    local author_name="$2"
    local author_pseudo="$3"
    
    mkdir -p "05-Worldbuilding/{Magie,Peuples,Histoire,GÃ©ographie}"
    
    cat > "00-instructions-llm/instructions.md" << EOF
# Instructions LLM - $project_name
*Projet SILK Fantasy - Smart Integrated Literary Kit*

## ðŸŽ¯ CONTEXTE PROJET  
**Genre** : Fantasy/Fantastique avec worldbuilding structurÃ©
**Auteur** : $author_name${author_pseudo:+ (pseudo: $author_pseudo)}
**Architecture** : SILK - Structured Intelligence for Literary Kreation

## ðŸ•·ï¸ APPROCHE SILK FANTASY
SILK tisse un univers cohÃ©rent et immersif :
- **Smart** : SystÃ¨me magique avec rÃ¨gles logiques
- **Integrated** : CohÃ©rence entre tous Ã©lÃ©ments d'univers
- **Literary** : Profondeur narrative au-delÃ  du spectacle
- **Kit** : Outils de worldbuilding systÃ©matiques

## ðŸŒ WORLDBUILDING SILK
### SystÃ¨me magique cohÃ©rent
- **RÃ¨gles fondamentales** : Lois physiques alternatives
- **Limitations claires** : CoÃ»t et contraintes rÃ©alistes
- **IntÃ©gration sociale** : Impact sur civilisation
- **Ã‰volution narrative** : Progression logique avec intrigue

### Construction univers
- **GÃ©ographie rÃ©flÃ©chie** : Climat, ressources, commerce
- **Cultures distinctes** : Langues, traditions, conflits
- **Histoire crÃ©dible** : Ã‰vÃ©nements formateurs logiques
- **DÃ©tails vÃ©cus** : Quotidien rÃ©aliste dans le fantastique

## ðŸ“‹ INSTRUCTIONS SPÃ‰CIFIQUES SILK
### CohÃ©rence narrative absolue
- **RÃ¨gles d'univers** : Jamais de violations arbitraires
- **Ã‰volution worldbuilding** : RÃ©vÃ©lations prÃ©parÃ©es
- **Ã‰quilibre rÃ©alisme/fantastique** : CrÃ©dibilitÃ© Ã©motionnelle
- **DÃ©tails immersifs** : SpÃ©cificitÃ©s qui rendent vivant

### DÃ©veloppement personnages fantasy
- **Motivations universelles** : Humaines malgrÃ© contexte fantastique
- **Pouvoirs et failles** : CapacitÃ©s avec coÃ»ts personnels
- **Conflits authentiques** : Enjeux Ã©motionnels rÃ©els
- **Arc transformation** : Croissance Ã  travers Ã©preuves fantastiques
EOF

    cat > "05-Worldbuilding/SystÃ¨me-Magique.md" << 'EOF'
# SystÃ¨me Magique SILK

## RÃ¨gles fondamentales
- **Source d'Ã©nergie** : D'oÃ¹ provient le pouvoir magique ?
- **MÃ©canisme d'accÃ¨s** : Comment les individus y accÃ¨dent-ils ?
- **Limitations physiques** : Fatigue, douleur, durÃ©e ?
- **CoÃ»t personnel** : Prix Ã©motionnel/spirituel/physique ?

## Applications pratiques
- **Combat magique** : Offensive/dÃ©fensive avec limitations
- **Magie utilitaire** : AmÃ©lioration vie quotidienne
- **Rituels complexes** : Grandes magies nÃ©cessitant prÃ©paration
- **Magie spontanÃ©e** : RÃ©actions Ã©motionnelles/instinctives

## IntÃ©gration sociale SILK
- **Acceptation culturelle** : Comment la sociÃ©tÃ© voit-elle la magie ?
- **RÃ©gulation/contrÃ´le** : Lois, guildes, restrictions ?
- **Apprentissage** : Formation, mentors, autodidactes ?
- **Stratification** : Classes sociales liÃ©es aux capacitÃ©s ?
- **Ã‰conomie magique** : Impact sur commerce et artisanat ?

## CohÃ©rence narrative
- **Ã‰volution historique** : Comment le systÃ¨me a-t-il Ã©voluÃ© ?
- **Conflits magiques** : Guerres, rÃ©volutions liÃ©es au pouvoir ?
- **MystÃ¨res non rÃ©solus** : Aspects encore incompris ?
- **Menaces existentielles** : Dangers du systÃ¨me lui-mÃªme ?
EOF

    # Template personnage fantasy
    cat > "02-Personnages/Principaux/Protagoniste-Mage.md" << 'EOF'
# [Nom Protagoniste]

## IdentitÃ©
- **Ã‚ge** : 
- **Origine** : RÃ©gion/culture de naissance
- **CapacitÃ©s magiques** : Niveau et spÃ©cialitÃ©s
- **Statut social** : Position dans hiÃ©rarchie magique/sociale

## Psychologie SILK Fantasy
### Motivations profondes
- **QuÃªte personnelle** : Objectif Ã©motionnel/spirituel
- **ResponsabilitÃ© magique** : Fardeau des capacitÃ©s
- **Peur du pouvoir** : Angoisse destruction/corruption

### Relation Ã  la magie
- **DÃ©couverte/apprentissage** : Comment a-t-il appris ?
- **Limites personnelles** : Faiblesses spÃ©cifiques
- **CoÃ»t Ã©motionnel** : Prix de l'usage magique
- **Ã‰volution prÃ©vue** : Progression des capacitÃ©s

## Arc narratif fantasy
- **RÃ©vÃ©lation pouvoir** : Prise de conscience capacitÃ©s
- **Apprentissage difficile** : MaÃ®trise et erreurs
- **Test limites** : Confrontation avec insuffisance
- **Transformation** : Nouveau rapport au pouvoir

## Relations dans l'univers
- [[Mentor magique]] : Guide et enseignements
- [[Rival/Nemesis]] : Opposition idÃ©ologique/magique
- [[ÃŠtre aimÃ©]] : VulnÃ©rabilitÃ© humaine malgrÃ© pouvoir
EOF
}

create_romance_templates() {
    local project_name="$1"
    local author_name="$2"
    local author_pseudo="$3"
    
    cat > "00-instructions-llm/instructions.md" << EOF
# Instructions LLM - $project_name
*Projet SILK Romance - Smart Integrated Literary Kit*

## ðŸŽ¯ CONTEXTE PROJET
**Genre** : Romance/DÃ©veloppement relationnel authentique
**Auteur** : $author_name${author_pseudo:+ (pseudo: $author_pseudo)}
**Architecture** : SILK - Structured Intelligence for Literary Kreation

## ðŸ•·ï¸ APPROCHE SILK ROMANCE
SILK tisse une histoire d'amour crÃ©dible et Ã©motionnellement satisfaisante :
- **Smart** : Psychologie relationnelle rÃ©aliste
- **Integrated** : Arc romantique cohÃ©rent avec dÃ©veloppement personnel
- **Literary** : Profondeur Ã©motionnelle au-delÃ  des clichÃ©s
- **Kit** : Outils narratifs pour romance authentique

## ðŸ’• MÃ‰CANIQUES ROMANCE SILK
### Arc relationnel structurÃ©
- **Rencontre significative** : Circonstances rÃ©vÃ©latrices
- **Attraction complexe** : Au-delÃ  du physique
- **Obstacles authentiques** : Conflits de valeurs/buts/peurs
- **Approfondissement graduel** : VulnÃ©rabilitÃ© progressive
- **Crise rÃ©vÃ©latrice** : Test de la soliditÃ© relationnelle
- **RÃ©solution mÃ©ritÃ©** : Engagement basÃ© sur croissance mutuelle

### DÃ©veloppement Ã©motionnel authentique
- **Dialogue naturel** : Conversations rÃ©vÃ©latrices et diffÃ©renciÃ©es
- **Chimie tangible** : Tension romantique sans explicite gratuit
- **Croissance individuelle** : Chaque partenaire Ã©volue
- **Conflits constructifs** : DÃ©saccords qui renforcent la relation

## ðŸ“‹ INSTRUCTIONS SPÃ‰CIFIQUES SILK
### Relations rÃ©alistes
- **Personnages complets** : Vies au-delÃ  de la romance
- **Communication authentique** : Maladresses et sincÃ©ritÃ©
- **Conflits crÃ©dibles** : ProblÃ¨mes rÃ©els, rÃ©solutions mÃ©ritÃ©es
- **Ã‰quilibre vulnÃ©rabilitÃ©/force** : Partenaires Ã©gaux et complÃ©mentaires
- **Respect mutuel** : Acceptation des diffÃ©rences

### Ã‰viter les Ã©cueils
- **Insta-love** : DÃ©veloppement graduel obligatoire
- **Perfection irrÃ©aliste** : DÃ©fauts humanisants
- **DÃ©pendance toxique** : Amour qui libÃ¨re, pas qui enchaÃ®ne
- **ClichÃ©s usÃ©s** : Situations originales et fraÃ®ches
EOF

    cat > "04-Concepts/Arc-Relationnel.md" << 'EOF'
# Arc Relationnel Principal SILK

## Ã‰tapes dÃ©veloppement romance
- **Rencontre marquante** : Circonstances rÃ©vÃ©latrices de personnalitÃ©
- **Attraction initiale** : Ã‰lÃ©ments d'attirance au-delÃ  du physique
- **RÃ©sistance/obstacles** : Peurs, diffÃ©rences, complications externes
- **Rapprochement** : Moments de vulnÃ©rabilitÃ© et dÃ©couverte mutuelle
- **Conflit majeur** : Test de la relation et des valeurs
- **RÃ©solution/engagement** : Choix conscient basÃ© sur croissance

## Dynamiques SILK
- **Chimie Ã©motionnelle** : Tension et complicitÃ© naturelles
- **ComplÃ©mentaritÃ©** : Forces qui compensent faiblesses mutuelles
- **Croissance parallÃ¨le** : Ã‰volution individuelle stimulÃ©e par la relation
- **Respect profond** : Admiration au-delÃ  de l'attraction

## Obstacles authentiques
- **Internes** : Peurs, traumatismes, insÃ©curitÃ©s personnelles
- **Externes** : Famille, carriÃ¨re, gÃ©ographie, classe sociale
- **Valeurs** : DiffÃ©rences fondamentales Ã  nÃ©gocier
- **Timing** : Mauvais moment dans parcours de vie

## RÃ©solution satisfaisante
- **Sacrifice mutuel** : Compromis Ã©quilibrÃ©s des deux cÃ´tÃ©s
- **Communication** : Dialogue honnÃªte sur besoins/peurs
- **Choix actif** : DÃ©cision consciente, pas simple "happy ending"
- **Vision partagÃ©e** : Projet de vie compatible dÃ©couvert
EOF
}

create_literary_templates() {
    local project_name="$1"
    local author_name="$2"
    local author_pseudo="$3"
    
    cat > "00-instructions-llm/instructions.md" << EOF
# Instructions LLM - $project_name
*Projet SILK Literary - Smart Integrated Literary Kit*

## ðŸŽ¯ CONTEXTE PROJET
**Genre** : LittÃ©rature contemporaine/gÃ©nÃ©rale
**Auteur** : $author_name${author_pseudo:+ (pseudo: $author_pseudo)}
**Architecture** : SILK - Structured Intelligence for Literary Kreation

## ðŸ•·ï¸ APPROCHE SILK LITERARY
SILK tisse une Å“uvre littÃ©raire cohÃ©rente et profonde :
- **Smart** : ThÃ¨mes universels traitÃ©s avec intelligence
- **Integrated** : Forme et fond en harmonie
- **Literary** : QualitÃ© d'Ã©criture et profondeur humaine
- **Kit** : Techniques narratives sophistiquÃ©es

## ðŸ“š MÃ‰CANIQUES LITERARY SILK
### Style et voix narrative
- **Voix distinctive** : Point de vue cohÃ©rent et personnel
- **Prose soignÃ©e** : Attention au rythme et Ã  la musicalitÃ©
- **Sous-texte riche** : Significations multiples et nuances
- **Ã‰conomie narrative** : Chaque Ã©lÃ©ment sert le propos

### DÃ©veloppement thÃ©matique
- **ThÃ¨mes universels** : Condition humaine, sociÃ©tÃ©, identitÃ©
- **Exploration nuancÃ©e** : Pas de rÃ©ponses simplistes
- **RÃ©sonance contemporaine** : Ancrage dans Ã©poque actuelle
- **Profondeur psychologique** : Motivations complexes

## ðŸ“‹ INSTRUCTIONS SPÃ‰CIFIQUES SILK
### Excellence littÃ©raire
- **CaractÃ©risation subtile** : RÃ©vÃ©lation progressive personnalitÃ©s
- **Dialogue authentique** : Voix distinctes et naturelles
- **Structure maÃ®trisÃ©e** : Architecture narrative rÃ©flÃ©chie
- **Symbolisme intÃ©grÃ©** : MÃ©taphores organiques, pas plaquÃ©es
EOF
}

create_publishing_templates() {
    local project_name="$1"
    local author_name="$2"
    
    cat > "formats/base.yaml" << EOF
title: "$project_name"
author: "$author_name"
date: "$(date '+%Y-%m-%d')"
lang: fr-FR
fontsize: 11pt
linestretch: 1.2
documentclass: book
classoption: 
  - openany
  - twoside
mainfont: "EB Garamond"
mainfontoptions:
  - Numbers=OldStyle
  - Ligatures=TeX
indent: true
block-headings: true
header-includes: |
  \usepackage[french]{babel}
  \usepackage{microtype}
  \clubpenalty=10000
  \widowpenalty=10000
  \usepackage{fancyhdr}
  \pagestyle{fancy}
  \fancyhf{}
  \fancyhead[LE,RO]{\thepage}
  \fancyhead[RE]{$project_name}
  \fancyhead[LO]{\leftmark}
  \renewcommand{\headrulewidth}{0pt}
EOF

    cat > "formats/digital.yaml" << 'EOF'
# Format Digital SILK - Lecture Ã©cran
geometry: "paperwidth=6in,paperheight=9in,margin=0.5in"
fontsize: 11pt
linestretch: 1.2
EOF

    cat > "formats/iphone.yaml" << 'EOF'
# Format iPhone SILK - Lecture mobile
geometry: "paperwidth=4.7in,paperheight=8.3in,margin=0.3in"
fontsize: 10pt
linestretch: 1.1
EOF

    cat > "formats/kindle.yaml" << 'EOF'
# Format Kindle SILK - Liseuse e-ink
geometry: "paperwidth=5in,paperheight=7.5in,margin=0.4in"
fontsize: 10pt
linestretch: 1.15
EOF

    cat > "formats/book.yaml" << 'EOF'
# Format Book SILK - Impression papier
geometry: "a5paper,margin=0.8in"
fontsize: 11pt
linestretch: 1.3
twoside: true
EOF
}

# === COMMANDE CONTEXT ===
cmd_context() {
    ensure_silk_context
    
    local question="Analyse gÃ©nÃ©rale"
    local chapter_range="all"
    local mode="normal"
    local include_timeline=false
    local include_wordcount=false
    local include_sharedcontext=true
    local output_combined=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                cat << 'HELP'
ðŸ•·ï¸ SILK CONTEXT - GÃ©nÃ©ration contexte optimisÃ© pour LLM

USAGE:
  silk context [QUESTION] [OPTIONS]

OPTIONS:
  -ch, --chapters RANGE     Chapitres (ex: 1-4, 20,28,30, all)
  --full                    Mode complet (tous Ã©lÃ©ments)
  --timeline                Inclure timeline dans manuscrit
  --wc, --wordcount         Inclure statistiques mots
  --no-metadata             Manuscrit seul (pas de mÃ©tadonnÃ©es)
  --combined                Un seul fichier contexte+manuscrit
  -h, --help                Afficher cette aide

EXEMPLES:
  silk context "RÃ©vision chapitre 15"
  silk context --chapters 1-10 --full
  silk context --timeline --wc
  silk context "CohÃ©rence Emma" -ch 15,18,20-25

MODES SILK:
  normal    Essentiel (personnages principaux + concepts)
  --full    Complet (+ personnages secondaires + lieux + stats)

RANGE SYNTAX:
  all         Tous les chapitres
  1-10        Chapitres 1 Ã  10 inclus
  15,20,25    Chapitres 15, 20 et 25
  10,15-18    Chapitre 10 + chapitres 15 Ã  18
  
SILK tisse le contexte parfait pour votre analyse LLM.
HELP
                return 0
                ;;
            -ch|--chapters)
                chapter_range="$2"
                shift 2
                ;;
            --full)
                mode="full"
                shift
                ;;
            --timeline)
                include_timeline=true
                shift
                ;;
            --wc|--wordcount)
                include_wordcount=true
                shift
                ;;
            --no-metadata)
                include_sharedcontext=false
                shift
                ;;
            --combined)
                output_combined=true
                shift
                ;;
            -*)
                log_error "Option inconnue: $1"
                return 1
                ;;
            *)
                question="$1"
                shift
                ;;
        esac
    done
    
    log_info "ðŸ•¸ï¸ SILK tisse le contexte LLM..."
    echo "   Question: $question"
    echo "   Chapitres: $chapter_range"
    echo "   Mode: $mode"
    
    # GÃ©nÃ©ration des fichiers contexte
    generate_silk_context "$question" "$chapter_range" "$mode" "$include_timeline" "$include_wordcount" "$include_sharedcontext" "$output_combined"
    
    log_success "Contexte SILK tissÃ© dans outputs/context/"
    
    # Statistiques des fichiers gÃ©nÃ©rÃ©s
    if [[ -f "outputs/context/manuscrit.md" ]]; then
        local word_count=$(wc -w < "outputs/context/manuscrit.md")
        log_info "ðŸ“– Manuscrit: $word_count mots"
    fi
    if [[ -f "outputs/context/sharedcontext.md" ]]; then
        local context_size=$(wc -w < "outputs/context/sharedcontext.md")
        log_info "ðŸ§  MÃ©tadonnÃ©es: $context_size mots"
    fi
    if [[ -f "outputs/context/silk-context-combined.md" ]]; then
        local combined_size=$(wc -w < "outputs/context/silk-context-combined.md")
        log_info "ðŸ•·ï¸ Contexte combinÃ©: $combined_size mots"
    fi
}

generate_silk_context() {
    local question="$1"
    local chapter_range="$2"
    local mode="$3"
    local include_timeline="$4"
    local include_wordcount="$5"
    local include_sharedcontext="$6"
    local output_combined="$7"
    
    mkdir -p "outputs/context"
    
    # GÃ©nÃ©rer manuscrit.md
    {
        echo "# ðŸ•·ï¸ SILK Manuscrit - Contexte LLM"
        echo "*Smart Integrated Literary Kit - Structured Intelligence for Literary Kreation*"
        echo
        echo "**Question:** $question"
        echo "**Chapitres:** $chapter_range"
        echo "**Mode:** $mode"
        echo "**GÃ©nÃ©rÃ© le:** $(date '+%Y-%m-%d %H:%M:%S')"
        echo "**Projet:** $(basename "$PWD")"
        echo
        echo "---"
        echo
        
        # Extraire chapitres selon le range
        extract_chapters_by_range "$chapter_range"
        
    } > "outputs/context/manuscrit.md"
    
    # GÃ©nÃ©rer sharedcontext.md si demandÃ©
    if [[ "$include_sharedcontext" == "true" ]]; then
        {
            echo "# ðŸ•¸ï¸ SILK MÃ©tadonnÃ©es - Contexte Projet"
            echo "*Smart Integrated Literary Kit - Structured Intelligence for Literary Kreation*"
            echo
            echo "**Question:** $question"
            echo "**Mode:** $mode"  
            echo "**GÃ©nÃ©rÃ© le:** $(date '+%Y-%m-%d %H:%M:%S')"
            echo "**Projet:** $(basename "$PWD")"
            echo
            echo "---"
            echo
            
            # Extraire mÃ©tadonnÃ©es selon le mode
            extract_metadata_by_mode "$mode"
            
            # Inclure statistiques si demandÃ©
            if [[ "$include_wordcount" == "true" ]]; then
                echo
                echo "## ðŸ“Š Statistiques Progression SILK"
                generate_wordcount_summary
            fi
            
        } > "outputs/context/sharedcontext.md"
    fi
    
    # GÃ©nÃ©rer fichier combinÃ© si demandÃ©
    if [[ "$output_combined" == "true" ]]; then
        {
            echo "# ðŸ•·ï¸ SILK Contexte Complet"
            echo "*Smart Integrated Literary Kit - Contexte LLM UnifiÃ©*"
            echo
            echo "**Question:** $question"
            echo "**Chapitres:** $chapter_range"
            echo "**Mode:** $mode"
            echo "**GÃ©nÃ©rÃ© le:** $(date '+%Y-%m-%d %H:%M:%S')"
            echo
            echo "---"
            echo
            
            if [[ "$include_sharedcontext" == "true" ]]; then
                echo "# ðŸ§  MÃ‰TADONNÃ‰ES PROJET"
                echo
                extract_metadata_by_mode "$mode"
                echo
                echo "---"
                echo
            fi
            
            echo "# ðŸ“– MANUSCRIT"
            echo
            extract_chapters_by_range "$chapter_range"
            
        } > "outputs/context/silk-context-combined.md"
    fi
}

parse_chapter_range() {
    local range="$1"
    local chapters=()
    
    if [[ "$range" == "all" ]]; then
        # Tous les chapitres disponibles
        for file in 01-Manuscrit/Ch*.md; do
            if [[ -f "$file" ]]; then
                local num=$(extract_chapter_number "$file")
                if [[ -n "$num" ]]; then
                    chapters+=("$num")
                fi
            fi
        done
    else
        # Parser les ranges complexes : 1-5,10,15-18
        IFS=',' read -ra PARTS <<< "$range"
        for part in "${PARTS[@]}"; do
            if [[ "$part" =~ ^([0-9]+)-([0-9]+)$ ]]; then
                # Range: 1-5
                local start="${BASH_REMATCH[1]}"
                local end="${BASH_REMATCH[2]}"
                for ((i=start; i<=end; i++)); do
                    chapters+=("$i")
                done
            elif [[ "$part" =~ ^[0-9]+$ ]]; then
                # NumÃ©ro simple: 10
                chapters+=("$part")
            fi
        done
    fi
    
    # Retourner la liste triÃ©e et unique
    printf '%s\n' "${chapters[@]}" | sort -nu
}

extract_chapter_number() {
    local filename="$(basename "$1")"
    # Extraire le numÃ©ro du chapitre depuis Ch01, Ch1, etc.
    if [[ "$filename" =~ ^[Cc]h0*([0-9]+) ]]; then
        echo "${BASH_REMATCH[1]}"
    fi
}

extract_chapters_by_range() {
    local range="$1"
    local chapter_nums
    readarray -t chapter_nums < <(parse_chapter_range "$range")
    
    if [[ ${#chapter_nums[@]} -eq 0 ]]; then
        echo "## âš ï¸ Aucun chapitre trouvÃ© pour le range: $range"
        return
    fi
    
    echo "## ðŸ“š Chapitres extraits: ${chapter_nums[*]}"
    echo
    
    for num in "${chapter_nums[@]}"; do
        # Chercher le fichier correspondant
        local found_file=""
        for file in 01-Manuscrit/Ch*.md; do
            if [[ -f "$file" ]]; then
                local file_num=$(extract_chapter_number "$file")
                if [[ "$file_num" == "$num" ]]; then
                    found_file="$file"
                    break
                fi
            fi
        done
        
        if [[ -n "$found_file" ]]; then
            local chapter_title=$(head -n1 "$found_file" | sed 's/^#*\s*//')
            echo "## $chapter_title"
            echo
            
            # Extraire le contenu aprÃ¨s "## manuscrit"
            local found_marker=false
            while IFS= read -r line; do
                if [[ "$line" == *"$VAULT_MARKER"* ]]; then
                    found_marker=true
                    continue
                fi
                
                if [[ "$found_marker" == true ]]; then
                    echo "$line"
                fi
            done < "$found_file"
            echo
            echo "---"
            echo
        else
            echo "## âš ï¸ Chapitre $num non trouvÃ©"
            echo
        fi
    done
}

extract_metadata_by_mode() {
    local mode="$1"
    
    # Instructions LLM toujours incluses
    if [[ -f "00-instructions-llm/instructions.md" ]]; then
        echo "## ðŸ§  Instructions LLM"
        cat "00-instructions-llm/instructions.md"
        echo
        echo "---"
        echo
    fi
    
    echo "## ðŸ‘¥ Personnages principaux"
    for file in 02-Personnages/*.md 02-Personnages/Principaux/*.md; do
        if [[ -f "$file" ]]; then
            echo "### $(basename "$file" .md)"
            cat "$file"
            echo
        fi
    done
    echo "---"
    echo

    echo "## ðŸ§© Concepts narratifs"
    for file in 04-Concepts/*.md; do
        if [[ -f "$file" ]]; then
            echo "### $(basename "$file" .md)"
            cat "$file"
            echo
        fi
    done
    echo "---"
    echo
    
    if [[ "$mode" == "full" ]]; then
        echo "## ðŸ‘¤ Personnages secondaires"
        for file in 02-Personnages/Secondaires/*.md 02-Personnages/Secondaires/*/*.md; do
            if [[ -f "$file" ]]; then
                echo "### $(basename "$file" .md)"
                cat "$file"
                echo
            fi
        done
        echo "---"
        echo
        
        echo "## ðŸ˜ï¸ Lieux"
        for file in 03-Lieux/*.md; do
            if [[ -f "$file" ]]; then
                echo "### $(basename "$file" .md)"
                cat "$file"
                echo
            fi
        done
        echo "---"
        echo
        
        # Worldbuilding pour fantasy
        if [[ -d "05-Worldbuilding" ]]; then
            echo "## ðŸŒ Worldbuilding"
            for file in 05-Worldbuilding/*.md 05-Worldbuilding/*/*.md; do
                if [[ -f "$file" ]]; then
                    echo "### $(basename "$file" .md)"
                    cat "$file"
                    echo
                fi
            done
            echo "---"
            echo
        fi
    fi
}

generate_wordcount_summary() {
    local total_words=0
    local chapter_count=0
    
    echo "### Progression manuscrit"
    echo
    echo "| Chapitre | Mots | Titre |"
    echo "|----------|------|-------|"
    
    for file in 01-Manuscrit/Ch*.md; do
        if [[ -f "$file" ]]; then
            local chapter_name=$(basename "$file" .md)
            local chapter_title=$(head -n1 "$file" | sed 's/^#*\s*//' | cut -c1-40)
            
            # Compter mots aprÃ¨s "## manuscrit"
            local words=0
            if grep -q "$VAULT_MARKER" "$file"; then
                words=$(sed -n "/$VAULT_MARKER/,\$p" "$file" | tail -n +2 | wc -w)
            fi
            
            if [[ $words -gt 0 ]]; then
                ((chapter_count++))
                total_words=$((total_words + words))
                echo "| $chapter_name | $words | $chapter_title |"
            fi
        fi
    done
    
    echo
    echo "**Total:** $total_words mots sur $chapter_count chapitres"
    if [[ $chapter_count -gt 0 ]]; then
        local avg_words=$((total_words / chapter_count))
        echo "**Moyenne:** $avg_words mots/chapitre"
    fi
}

# === COMMANDE WORDCOUNT ===
cmd_wordcount() {
    ensure_silk_context
    
    local target_words="${SILK_DEFAULT_TARGET_WORDS:-80000}"
    local show_details=true
    local show_projections=true
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                cat << 'HELP'
ðŸ“Š SILK WORDCOUNT - Statistiques progression manuscrit

USAGE:
  silk wordcount [TARGET_WORDS] [OPTIONS]

OPTIONS:
  -t, --target NUMBER       Objectif en mots (dÃ©faut config)
  --summary                 RÃ©sumÃ© uniquement (pas de dÃ©tails)
  --no-projections         Pas de calculs objectif
  -h, --help                Afficher cette aide

EXEMPLES:
  silk wordcount             # Objectif depuis config
  silk wordcount 100000      # Objectif 100k mots
  silk wordcount -t 60000    # Objectif 60k (novella)
  silk wordcount --summary   # RÃ©sumÃ© rapide

SEUILS DE RÃ‰FÃ‰RENCE SILK:
  40k mots   = ~160 pages   (novella courte)
  60k mots   = ~240 pages   (roman court)  
  80k mots   = ~320 pages   (standard)
  100k mots  = ~400 pages   (gros roman)
  120k mots  = ~480 pages   (trÃ¨s gros roman)
  
SILK analyse intelligemment votre progression.
HELP
                return 0
                ;;
            -t|--target)
                target_words="$2"
                shift 2
                ;;
            --summary)
                show_details=false
                shift
                ;;
            --no-projections)
                show_projections=false
                shift
                ;;
            -*)
                log_error "Option inconnue: $1"
                return 1
                ;;
            *)
                if [[ "$1" =~ ^[0-9]+$ ]]; then
                    target_words="$1"
                fi
                shift
                ;;
        esac
    done
    
    log_info "ðŸ•¸ï¸ SILK analyse votre progression (objectif: $target_words mots)"
    
    analyze_silk_wordcount "$target_words" "$show_details" "$show_projections"
}

analyze_silk_wordcount() {
    local target_words="$1"
    local show_details="$2"
    local show_projections="$3"
    
    local total_words=0
    local chapter_count=0
    local min_words=999999
    local max_words=0
    local min_chapter=""
    local max_chapter=""
    local chapter_data=()
    
    # Collecte des donnÃ©es
    for file in 01-Manuscrit/Ch*.md; do
        if [[ -f "$file" ]]; then
            local chapter_name=$(basename "$file" .md)
            local chapter_title=$(head -n1 "$file" | sed 's/^#*\s*//')
            
            # Extraire contenu aprÃ¨s "## manuscrit"
            local words=0
            if grep -q "$VAULT_MARKER" "$file"; then
                words=$(sed -n "/$VAULT_MARKER/,\$p" "$file" | tail -n +2 | wc -w)
            fi
            
            if [[ $words -gt 0 ]]; then
                ((chapter_count++))
                total_words=$((total_words + words))
                
                chapter_data+=("$chapter_name:$words:$chapter_title")
                
                if [[ $words -lt $min_words ]]; then
                    min_words=$words
                    min_chapter="$chapter_name"
                fi
                
                if [[ $words -gt $max_words ]]; then
                    max_words=$words
                    max_chapter="$chapter_name"
                fi
            fi
        fi
    done
    
    if [[ $chapter_count -eq 0 ]]; then
        log_warning "Aucun chapitre avec contenu trouvÃ©"
        echo "ðŸ’¡ Ajoutez du contenu aprÃ¨s '$VAULT_MARKER' dans vos chapitres"
        return
    fi
    
    # Affichage dÃ©taillÃ©
    if [[ "$show_details" == "true" ]]; then
        echo
        echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
        echo "â”‚ CHAPITREâ”‚  MOTS   â”‚ TITRE                                                 â”‚"
        echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
        
        for data in "${chapter_data[@]}"; do
            IFS=':' read -r chapter_name words chapter_title <<< "$data"
            
            # Tronquer titre si trop long
            local display_title="${chapter_title:0:53}"
            if [[ ${#chapter_title} -gt 53 ]]; then
                display_title="${display_title}..."
            fi
            
            printf "â”‚  %-6s â”‚ %6s  â”‚ %-53s â”‚\n" "$chapter_name" "$words" "$display_title"
        done
        
        echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
        echo
    fi
    
    # Statistiques globales
    local avg_words=$((total_words / chapter_count))
    local words_needed=$((target_words - total_words))
    
    echo "ðŸ•·ï¸ SILK ANALYTICS - STATISTIQUES GLOBALES"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Total chapitres Ã©crits    : $chapter_count"
    echo "Total mots manuscrit      : $total_words"
    echo "Moyenne actuelle/chapitre : $avg_words mots"
    if [[ "$show_details" == "true" ]]; then
        echo "Chapitre le plus court    : $min_chapter ($min_words mots)"
        echo "Chapitre le plus long     : $max_chapter ($max_words mots)"
    fi
    echo
    
    # Projections vers objectif
    if [[ "$show_projections" == "true" ]]; then
        if [[ $words_needed -gt 0 ]]; then
            local words_per_chapter=$((words_needed / chapter_count))
            local target_avg=$((target_words / chapter_count))
            local current_pages=$((total_words / 250))
            local target_pages=$((target_words / 250))
            
            echo "ðŸŽ¯ SILK PROJECTIONS - OBJECTIF $target_words MOTS"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Objectif configurÃ©        : $target_words mots (~$target_pages pages)"
            echo "Mots Ã  ajouter            : $words_needed mots"
            echo "Mots Ã  ajouter/chapitre   : +$words_per_chapter mots"
            echo "Moyenne cible/chapitre    : $target_avg mots"
            echo
            
            # Recommandations SILK
            if [[ $words_per_chapter -lt 300 ]]; then
                echo "âœ… SILK Ã‰valuation: Objectif trÃ¨s rÃ©alisable (+$words_per_chapter mots/chapitre)"
                echo "   ðŸ’¡ Suggestion: DÃ©veloppez les scÃ¨nes existantes"
            elif [[ $words_per_chapter -lt 600 ]]; then
                echo "ðŸŸ¡ SILK Ã‰valuation: Effort modÃ©rÃ© (+$words_per_chapter mots/chapitre)"
                echo "   ðŸ’¡ Suggestion: Ajoutez sous-trames et dÃ©veloppement personnages"
            elif [[ $words_per_chapter -lt 1000 ]]; then
                echo "ðŸŸ  SILK Ã‰valuation: Effort important (+$words_per_chapter mots/chapitre)"
                echo "   ðŸ’¡ Suggestion: Enrichissez descriptions et dialogues"
            else
                echo "ðŸ”¥ SILK Ã‰valuation: Effort trÃ¨s important (+$words_per_chapter mots/chapitre)"
                echo "   ðŸ’¡ Suggestion: ConsidÃ©rez ajouter de nouveaux chapitres"
                echo "   ðŸŽ¯ Alternative: RÃ©visez l'objectif Ã  $((total_words + chapter_count * 800)) mots"
            fi
        else
            echo "ðŸŽ‰ SILK SUCCESS - OBJECTIF ATTEINT !"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Objectif configurÃ©        : $target_words mots"
            echo "DÃ©passement               : $((-words_needed)) mots"
            echo "ðŸ† FÃ©licitations ! Temps de peaufiner et publier."
        fi
    fi
    
    # Position dans les seuils
    echo
    echo "ðŸ“– SILK POSITIONNEMENT - STANDARDS Ã‰DITORIAUX"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”